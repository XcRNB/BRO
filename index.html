<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>账 · Git</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body{background:#000;padding:8px;}
.app{background:#fff;border:2px solid #000;padding:16px;max-width:500px;margin:0 auto;}
.top{display:flex;justify-content:space-between;margin-bottom:16px;}
#key{width:100%;padding:14px;font-size:18px;border:2px solid #000;margin-bottom:16px;}
.show{border:2px solid #000;padding:20px;text-align:center;margin-bottom:20px;}
.show div:first-child{font-size:40px;font-weight:700;}
.show div:last-child{font-size:32px;font-family:monospace;}
.hide{display:none!important;}
.row{display:flex;align-items:center;gap:6px;margin-bottom:8px;}
.row input{flex:1;border:2px solid #000;padding:10px;}
.row div{display:flex;gap:5px;}
.btn{border:2px solid #000;padding:8px 14px;background:#fff;font-weight:600;}
.btn-dark{background:#000;color:#fff;}
.addgroup{display:flex;gap:6px;margin-top:10px;}
.addgroup input{flex:1;border:2px solid #000;padding:12px;}
</style>
</head>
<body>
<div class="app">
  <div class="top"><h2>Git 库</h2><button class="btn" id="adminBtn">后台</button></div>
  
  <div id="front">
    <input id="key" placeholder="编号" autofocus>
    <div class="show" id="res"><div>-</div><div>-</div></div>
  </div>
  
  <div id="adminView" class="hide">
    <div class="top"><h2>管理</h2><button class="btn" id="backBtn">返回</button></div>
    <div id="adminList"></div>
    <div class="addgroup">
      <input id="nid" placeholder="编号">
      <input id="nnm" placeholder="姓名">
      <input id="nps" placeholder="密码">
      <button class="btn btn-dark" id="addBtn">增</button>
    </div>
    <p style="color:#c00;font-size:13px;margin-top:15px;text-align:center;">⚠️ 改完后点「存」或「增」自动下载 list.json，手动上传 GitHub 覆盖</p>
  </div>
</div>

<script>
// ===== 读写 list.json（GitHub 数据库）=====
let data = [];

// 读取 list.json
async function loadList() {
  try {
    let res = await fetch('list.json');
    data = await res.json();
  } catch(e) {
    alert('读取 list.json 失败，请确认文件已上传');
    data = [];
  }
}

// 保存到本地文件（手动上传 GitHub）
function saveToList() {
  let jsonStr = JSON.stringify(data, null, 2);
  let blob = new Blob([jsonStr], {type: 'application/json'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = 'list.json';  // 直接覆盖 list.json
  a.click();
  alert('✅ list.json 已下载，请手动上传到 GitHub 覆盖旧文件');
}

// 渲染后台
function renderAdmin() {
  let h = '';
  data.forEach((v,i) => {
    h += `<div class="row">
      <input id="id_${i}" value="${v.id}">
      <input id="name_${i}" value="${v.name}">
      <input id="pass_${i}" value="${v.pass}">
      <div>
        <button class="btn" onclick="editItem(${i})">存</button>
        <button class="btn" onclick="delItem(${i})">删</button>
      </div>
    </div>`;
  });
  document.getElementById('adminList').innerHTML = h;
}

// 编辑
window.editItem = function(i) {
  let id = document.getElementById(`id_${i}`).value;
  let name = document.getElementById(`name_${i}`).value;
  let pass = document.getElementById(`pass_${i}`).value;
  if (id && name && pass) {
    data[i] = {id, name, pass};
    renderAdmin();
    saveToList();  // 自动下载 list.json
  }
};

// 删除
window.delItem = function(i) {
  if (confirm('确认删除？')) {
    data.splice(i, 1);
    renderAdmin();
    saveToList();  // 自动下载 list.json
  }
};

// 查询
document.getElementById('key').oninput = function() {
  let v = this.value.trim();
  let x = data.find(d => d.id === v);
  document.getElementById('res').innerHTML = v 
    ? x ? `<div>${x.name}</div><div>${x.pass}</div>` : '<div>无</div><div>-</div>'
    : '<div>-</div><div>-</div>';
};

// 后台密码验证
let c = 0;
document.getElementById('adminBtn').onclick = async function(e) {
  e.preventDefault(); c++;
  if (c === 3) {
    try {
      let r = await fetch('password.json');
      let pwd = await r.json();
      if (prompt('后台密码') === pwd.admin) {
        document.getElementById('front').classList.add('hide');
        document.getElementById('adminView').classList.remove('hide');
        renderAdmin();
      } else alert('密码错误');
    } catch(e) {
      alert('读取 password.json 失败');
    }
    c = 0;
  }
};

// 返回前台
document.getElementById('backBtn').onclick = function(e) {
  e.preventDefault();
  document.getElementById('adminView').classList.add('hide');
  document.getElementById('front').classList.remove('hide');
};

// 增加账号
document.getElementById('addBtn').onclick = function() {
  let id = document.getElementById('nid').value;
  let name = document.getElementById('nnm').value;
  let pass = document.getElementById('nps').value;
  if (id && name && pass) {
    if (data.find(v => v.id === id)) { alert('编号已存在'); return; }
    data.push({id, name, pass});
    renderAdmin();
    saveToList();  // 自动下载 list.json
    document.getElementById('nid').value = '';
    document.getElementById('nnm').value = '';
    document.getElementById('nps').value = '';
  }
};

// 初始化
loadList();
</script>
</body>
</html>
