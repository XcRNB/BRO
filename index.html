<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>账</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body{background:#000;padding:0;}
.a{width:100%;background:#fff;border:2px solid #000;min-height:100vh;padding:16px;}
.b{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.c{width:100%;padding:14px;font-size:18px;border:2px solid #000;margin-bottom:16px;}
.d{border:2px solid #000;padding:20px;text-align:center;margin-bottom:20px;}
.d div:first-child{font-size:40px;font-weight:700;}
.d div:last-child{font-size:32px;font-family:monospace;}
.e{display:none!important;}
.f{display:flex;align-items:center;gap:6px;margin-bottom:8px;}
.f input{flex:1;border:2px solid #000;padding:10px;font-size:15px;}
.f div{display:flex;gap:5px;}
.g{margin-bottom:20px;}
.h{display:flex;gap:6px;margin-top:5px;}
.h input{flex:1;border:2px solid #000;padding:12px;font-size:15px;}
.btn{border:2px solid #000;padding:8px 14px;background:#fff;font-weight:600;}
.btn2{background:#000;color:#fff;}
</style>
</head>
<body>
<div class="a">
  <div class="b"><h2>账</h2><button class="btn" id="a1">后</button></div>
  
  <div id="b1">
    <input class="c" id="c1" placeholder="编号" autofocus>
    <div class="d" id="d1"><div>-</div><div>-</div></div>
  </div>
  
  <div id="b2" class="e">
    <div class="b"><h2>后</h2><button class="btn" id="e1">返</button></div>
    <div id="f1" class="g"></div>
    <div class="h">
      <input id="g1" placeholder="编">
      <input id="g2" placeholder="姓">
      <input id="g3" placeholder="密">
      <button class="btn btn2" id="h1">增</button>
    </div>
  </div>
</div>

<script>
let data = [];
let init = async () => {
  let url = new URLSearchParams(location.search).get('d');
  if (url) {
    try { data = JSON.parse(decodeURIComponent(url)); } catch(e) {}
    renderFront();
    return;
  }
  try {
    let res = await fetch('list.json');
    data = await res.json();
    toURL();
  } catch(e) {
    alert('list.json?');
  }
};

let toURL = () => {
  let e = encodeURIComponent(JSON.stringify(data));
  history.pushState({}, '', location.pathname + '?d=' + e);
  renderFront();
};

let renderFront = () => {
  let i = document.getElementById('c1');
  if (i) i.value = '';
  document.getElementById('d1').innerHTML = '<div>-</div><div>-</div>';
};

let renderAdmin = () => {
  let h = '';
  data.forEach((v,i) => {
    h += `<div class="f">
      <input id="i${i}" value="${v.id}">
      <input id="j${i}" value="${v.name}">
      <input id="k${i}" value="${v.pass}">
      <div>
        <button class="btn" onclick="edit(${i})">存</button>
        <button class="btn" onclick="del(${i})">删</button>
      </div>
    </div>`;
  });
  document.getElementById('f1').innerHTML = h;
};

window.edit = (i) => {
  let id = document.getElementById(`i${i}`).value;
  let nm = document.getElementById(`j${i}`).value;
  let ps = document.getElementById(`k${i}`).value;
  if (id && nm && ps) {
    data[i] = {id, name: nm, pass: ps};
    toURL();
    renderAdmin();
  }
};

window.del = (i) => {
  data.splice(i, 1);
  toURL();
  renderAdmin();
};

document.getElementById('c1').oninput = function() {
  let v = this.value.trim();
  let x = data.find(d => d.id === v);
  document.getElementById('d1').innerHTML = v 
    ? x ? `<div>${x.name}</div><div>${x.pass}</div>` : '<div>无</div><div>-</div>'
    : '<div>-</div><div>-</div>';
};

let cnt = 0;
document.getElementById('a1').onclick = async function(e) {
  e.preventDefault();
  cnt++;
  if (cnt == 3) {
    try {
      let r = await fetch('password.json');
      let p = await r.json();
      if (prompt('密码') === p.admin) {
        document.getElementById('b1').classList.add('e');
        document.getElementById('b2').classList.remove('e');
        renderAdmin();
      } else alert('x');
    } catch(e) {
      alert('password.json?');
    }
    cnt = 0;
  }
};

document.getElementById('e1').onclick = function(e) {
  e.preventDefault();
  document.getElementById('b2').classList.add('e');
  document.getElementById('b1').classList.remove('e');
};

document.getElementById('h1').onclick = function() {
  let id = document.getElementById('g1').value;
  let nm = document.getElementById('g2').value;
  let ps = document.getElementById('g3').value;
  if (id && nm && ps) {
    if (data.find(v => v.id === id)) { alert('已存在'); return; }
    data.push({id, name: nm, pass: ps});
    toURL();
    renderAdmin();
    document.getElementById('g1').value = '';
    document.getElementById('g2').value = '';
    document.getElementById('g3').value = '';
  }
};

init();
</script>
</body>
</html>
