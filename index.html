<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BRO · 查询端</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body{background:#000;padding:8px;}
.app{background:#fff;border:2px solid #000;padding:16px;max-width:500px;margin:0 auto;}
.top{display:flex;justify-content:space-between;margin-bottom:16px;}
#key{width:100%;padding:14px;font-size:18px;border:2px solid #000;margin-bottom:16px;}
.show{border:2px solid #000;padding:20px;text-align:center;margin-bottom:20px;}
.show div:first-child{font-size:40px;font-weight:700;}
.show div:last-child{font-size:32px;font-family:monospace;}
</style>
</head>
<body>
<div class="app">
  <div class="top"><h2>BRO · 查号</h2><button class="btn" id="adminBtn" style="border:2px solid #000;padding:8px 14px;background:#fff;font-weight:600;">后台</button></div>
  <input id="key" placeholder="编号" autofocus>
  <div class="show" id="res"><div>-</div><div>-</div></div>
</div>

<script>
let data = [];
const owner = 'XcRNB';
const repo = 'BRO';
const path = 'list.json';
const token = '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';

// 从GitHub读取数据
async function loadFromGitHub() {
  try {
    let url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    let res = await fetch(url, {
      headers: { 'Authorization': `token ${token}` }
    });
    if (!res.ok) throw new Error('GitHub读取失败');
    let result = await res.json();
    let content = decodeURIComponent(escape(atob(result.content)));
    data = JSON.parse(content);
    localStorage.setItem('backup', JSON.stringify(data));
  } catch(e) {
    let backup = localStorage.getItem('backup');
    if (backup) {
      data = JSON.parse(backup);
    } else {
      try {
        let fileRes = await fetch('list.json?' + Date.now());
        data = await fileRes.json();
      } catch(e2) {
        data = [];
      }
    }
  }
}

// 查询
document.getElementById('key').oninput = function() {
  let v = this.value.trim();
  let x = data.find(d => d.id === v);
  document.getElementById('res').innerHTML = v 
    ? x ? `<div>${x.name}</div><div>${x.pass}</div>` : '<div>无</div><div>-</div>'
    : '<div>-</div><div>-</div>';
};

// 卡密验证并跳转后台
let c = 0;
document.getElementById('adminBtn').onclick = async function(e) {
  e.preventDefault();
  c++;
  if (c === 3) {
    try {
      let r = await fetch('password.json?' + Date.now());
      let pwd = await r.json();
      if (prompt('后台密码') === pwd.admin) {
        // 跳转到admin.html，同时把token和仓库信息传过去
        window.location.href = 'admin.html?owner=' + owner + '&repo=' + repo + '&token=' + token;
      } else {
        alert('密码错误');
      }
    } catch(e) {
      alert('读取密码失败');
    }
    c = 0;
  }
};

loadFromGitHub();
</script>
</body>
</html>
