<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BRO · 查询端</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body{background:#000;padding:8px;}
.app{background:#fff;border:2px solid #000;padding:16px;max-width:500px;margin:0 auto;}
.top{display:flex;justify-content:space-between;margin-bottom:16px;}
#key{width:100%;padding:14px;font-size:18px;border:2px solid #000;margin-bottom:16px;}
.show{border:2px solid #000;padding:20px;text-align:center;margin-bottom:20px;}
.show div:first-child{font-size:40px;font-weight:700;}
.show div:last-child{font-size:32px;font-family:monospace;}
</style>
</head>
<body>
<div class="app">
  <div class="top"><h2>BRO · 查号</h2><button class="btn" id="adminBtn" style="border:2px solid #000;padding:8px 14px;background:#fff;font-weight:600;">后台</button></div>
  <input id="key" placeholder="编号" autofocus>
  <div class="show" id="res"><div>-</div><div>-</div></div>
</div>

<script>
let data = [];
let owner = '', repo = '', token = '', path = 'list.json';

// 从important.json读取敏感信息
async function loadImportant() {
  try {
    let res = await fetch('important.json?' + Date.now());
    if (!res.ok) {
      throw new Error('文件不存在 (HTTP ' + res.status + ')');
    }
    let imp = await res.json();
    owner = imp.owner;
    repo = imp.repo;
    token = imp.token;
    console.log('important.json 读取成功');
    return true;
  } catch(e) {
    alert('读取important.json失败：' + e.message + '\n\n请确认文件已上传到仓库');
    return false;
  }
}

// 从GitHub读取数据
async function loadFromGitHub() {
  if (!owner || !repo || !token) {
    console.log('敏感信息未加载');
    return;
  }
  try {
    let url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    let res = await fetch(url, {
      headers: { 'Authorization': `token ${token}` }
    });
    if (!res.ok) throw new Error('GitHub读取失败');
    let result = await res.json();
    let content = decodeURIComponent(escape(atob(result.content)));
    data = JSON.parse(content);
    localStorage.setItem('backup', JSON.stringify(data));
  } catch(e) {
    let backup = localStorage.getItem('backup');
    if (backup) {
      data = JSON.parse(backup);
    } else {
      try {
        let fileRes = await fetch('list.json?' + Date.now());
        data = await fileRes.json();
      } catch(e2) {
        data = [];
      }
    }
  }
}

// 查询
document.getElementById('key').oninput = function() {
  let v = this.value.trim();
  let x = data.find(d => d.id === v);
  document.getElementById('res').innerHTML = v 
    ? x ? `<div>${x.name}</div><div>${x.pass}</div>` : '<div>无</div><div>-</div>'
    : '<div>-</div><div>-</div>';
};

// 卡密验证并跳转后台
let c = 0;
document.getElementById('adminBtn').onclick = async function(e) {
  e.preventDefault();
  c++;
  if (c === 3) {
    try {
      // 先加载important.json
      let loaded = await loadImportant();
      if (!loaded) return;
      
      // 读取密码
      let pwdRes = await fetch('password.json?' + Date.now());
      let pwd = await pwdRes.json();
      if (prompt('后台密码') === pwd.admin) {
        // 编码后跳转
        let encodedOwner = btoa(owner);
        let encodedRepo = btoa(repo);
        let encodedToken = btoa(token);
        window.location.href = 'admin.html?o=' + encodedOwner + '&r=' + encodedRepo + '&t=' + encodedToken;
      } else {
        alert('密码错误');
      }
    } catch(e) {
      alert('读取密码失败：' + e.message);
    }
    c = 0;
  }
};

// 初始化：先加载important，再加载数据
(async function init() {
  await loadImportant();
  await loadFromGitHub();
})();
</script>
</body>
</html><!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BRO · 查询端</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body{background:#000;padding:8px;}
.app{background:#fff;border:2px solid #000;padding:16px;max-width:500px;margin:0 auto;}
.top{display:flex;justify-content:space-between;margin-bottom:16px;}
#key{width:100%;padding:14px;font-size:18px;border:2px solid #000;margin-bottom:16px;}
.show{border:2px solid #000;padding:20px;text-align:center;margin-bottom:20px;}
.show div:first-child{font-size:40px;font-weight:700;}
.show div:last-child{font-size:32px;font-family:monospace;}
</style>
</head>
<body>
<div class="app">
  <div class="top"><h2>BRO · 查号</h2><button class="btn" id="adminBtn" style="border:2px solid #000;padding:8px 14px;background:#fff;font-weight:600;">后台</button></div>
  <input id="key" placeholder="编号" autofocus>
  <div class="show" id="res"><div>-</div><div>-</div></div>
</div>

<script>
let data = [];
let owner = '', repo = '', token = '', path = 'list.json';

// 从important.json读取敏感信息
async function loadImportant() {
  try {
    let res = await fetch('important.json?' + Date.now());
    let imp = await res.json();
    owner = imp.owner;
    repo = imp.repo;
    token = imp.token;
    return true;
  } catch(e) {
    alert('读取important.json失败');
    return false;
  }
}

// 从GitHub读取数据
async function loadFromGitHub() {
  if (!owner || !repo || !token) return;
  try {
    let url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    let res = await fetch(url, {
      headers: { 'Authorization': `token ${token}` }
    });
    if (!res.ok) throw new Error('GitHub读取失败');
    let result = await res.json();
    let content = decodeURIComponent(escape(atob(result.content)));
    data = JSON.parse(content);
    localStorage.setItem('backup', JSON.stringify(data));
  } catch(e) {
    let backup = localStorage.getItem('backup');
    if (backup) {
      data = JSON.parse(backup);
    } else {
      try {
        let fileRes = await fetch('list.json?' + Date.now());
        data = await fileRes.json();
      } catch(e2) {
        data = [];
      }
    }
  }
}

// 查询
document.getElementById('key').oninput = function() {
  let v = this.value.trim();
  let x = data.find(d => d.id === v);
  document.getElementById('res').innerHTML = v 
    ? x ? `<div>${x.name}</div><div>${x.pass}</div>` : '<div>无</div><div>-</div>'
    : '<div>-</div><div>-</div>';
};

// 卡密验证并跳转后台
let c = 0;
document.getElementById('adminBtn').onclick = async function(e) {
  e.preventDefault();
  c++;
  if (c === 3) {
    try {
      // 读取密码
      let pwdRes = await fetch('password.json?' + Date.now());
      let pwd = await pwdRes.json();
      if (prompt('后台密码') === pwd.admin) {
        // 跳转前确保important已加载
        await loadImportant();
        // 把重要信息通过URL传递（但用编码隐藏一下）
        let encodedOwner = btoa(owner);
        let encodedRepo = btoa(repo);
        let encodedToken = btoa(token);
        window.location.href = 'admin.html?o=' + encodedOwner + '&r=' + encodedRepo + '&t=' + encodedToken;
      } else {
        alert('密码错误');
      }
    } catch(e) {
      alert('读取密码失败');
    }
    c = 0;
  }
};

// 初始化：先加载important，再加载数据
(async function init() {
  await loadImportant();
  await loadFromGitHub();
})();
</script>
</body>
</html>
