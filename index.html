<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>BRO · 直写</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui;}
body{background:#000;padding:8px;}
.app{background:#fff;border:2px solid #000;padding:16px;max-width:500px;margin:0 auto;}
.top{display:flex;justify-content:space-between;margin-bottom:16px;}
#key{width:100%;padding:14px;font-size:18px;border:2px solid #000;margin-bottom:16px;}
.show{border:2px solid #000;padding:20px;text-align:center;margin-bottom:20px;}
.show div:first-child{font-size:40px;font-weight:700;}
.show div:last-child{font-size:32px;font-family:monospace;}
.hide{display:none!important;}
.row{display:flex;align-items:center;gap:6px;margin-bottom:8px;}
.row input{flex:1;border:2px solid #000;padding:10px;}
.row div{display:flex;gap:5px;}
.btn{border:2px solid #000;padding:8px 14px;background:#fff;font-weight:600;}
.btn-dark{background:#000;color:#fff;}
.addgroup{display:flex;gap:6px;margin-top:10px;}
.addgroup input{flex:1;border:2px solid #000;padding:12px;}
</style>
</head>
<body>
<div class="app">
  <div class="top"><h2>BRO · 直写</h2><button class="btn" id="adminBtn">后台</button></div>
  
  <div id="front">
    <input id="key" placeholder="编号" autofocus>
    <div class="show" id="res"><div>-</div><div>-</div></div>
  </div>
  
  <div id="adminView" class="hide">
    <div class="top"><h2>管理</h2><button class="btn" id="backBtn">返回</button></div>
    <div id="adminList"></div>
    <div class="addgroup">
      <input id="nid" placeholder="编号">
      <input id="nnm" placeholder="姓名">
      <input id="nps" placeholder="密码">
      <button class="btn btn-dark" id="addBtn">增</button>
    </div>
  </div>
</div>

<script>
let data = [];
const owner = 'XcRNB';
const repo = 'BRO';
const path = 'list.json';
const token = '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';

// ===== 从 list.json 读取 =====
async function loadFromFile() {
  try {
    let res = await fetch('list.json?' + Date.now());
    data = await res.json();
    return true;
  } catch(e) {
    console.log('读取list.json失败，使用空数据');
    data = [];
    return false;
  }
}

// ===== 保存到 GitHub =====
async function saveToGitHub(newData) {
  try {
    let content = btoa(unescape(encodeURIComponent(JSON.stringify(newData, null, 2))));
    
    // 获取当前文件的 sha
    let getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      headers: { 'Authorization': `token ${token}` }
    });
    
    if (!getRes.ok) {
      alert('获取文件失败：' + getRes.status);
      return false;
    }
    
    let getData = await getRes.json();
    let sha = getData.sha;
    
    // 写入新内容
    let putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: { 
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'update list.json',
        content: content,
        sha: sha
      })
    });
    
    if (putRes.ok) {
      data = newData;
      renderAdmin();
      localStorage.setItem('backup', JSON.stringify(newData));
      alert('✅ 保存成功');
      return true;
    } else {
      alert('写入失败');
      return false;
    }
  } catch(e) {
    alert('保存失败：' + e.message);
    return false;
  }
}

function renderAdmin() {
  let h = '';
  data.forEach((v,i) => {
    h += `<div class="row">
      <input id="id_${i}" value="${v.id}">
      <input id="name_${i}" value="${v.name}">
      <input id="pass_${i}" value="${v.pass}">
      <div>
        <button class="btn" onclick="editItem(${i})">存</button>
        <button class="btn" onclick="delItem(${i})">删</button>
      </div>
    </div>`;
  });
  document.getElementById('adminList').innerHTML = h;
}

window.editItem = async function(i) {
  let id = document.getElementById(`id_${i}`).value;
  let name = document.getElementById(`name_${i}`).value;
  let pass = document.getElementById(`pass_${i}`).value;
  if (id && name && pass) {
    let newData = [...data];
    newData[i] = {id, name, pass};
    await saveToGitHub(newData);
  }
};

window.delItem = async function(i) {
  if (confirm('确认删除？')) {
    let newData = [...data];
    newData.splice(i, 1);
    await saveToGitHub(newData);
  }
};

document.getElementById('key').oninput = function() {
  let v = this.value.trim();
  let x = data.find(d => d.id === v);
  document.getElementById('res').innerHTML = v 
    ? x ? `<div>${x.name}</div><div>${x.pass}</div>` : '<div>无</div><div>-</div>'
    : '<div>-</div><div>-</div>';
};

let c = 0;
document.getElementById('adminBtn').onclick = async function(e) {
  e.preventDefault(); c++;
  if (c === 3) {
    try {
      let r = await fetch('password.json?' + Date.now());
      let pwd = await r.json();
      if (prompt('后台密码') === pwd.admin) {
        let backup = localStorage.getItem('backup');
        if (backup) {
          data = JSON.parse(backup);
        } else {
          await loadFromFile();
        }
        document.getElementById('front').classList.add('hide');
        document.getElementById('adminView').classList.remove('hide');
        renderAdmin();
      } else alert('密码错误');
    } catch(e) {
      alert('读取 password.json 失败');
    }
    c = 0;
  }
};

document.getElementById('backBtn').onclick = function(e) {
  e.preventDefault();
  document.getElementById('adminView').classList.add('hide');
  document.getElementById('front').classList.remove('hide');
};

document.getElementById('addBtn').onclick = async function() {
  let id = document.getElementById('nid').value;
  let name = document.getElementById('nnm').value;
  let pass = document.getElementById('nps').value;
  if (id && name && pass) {
    if (data.find(v => v.id === id)) { 
      alert('编号已存在'); 
      return; 
    }
    let newData = [...data];
    newData.push({id, name, pass});
    await saveToGitHub(newData);
    document.getElementById('nid').value = '';
    document.getElementById('nnm').value = '';
    document.getElementById('nps').value = '';
  }
};

loadFromFile();
</script>
</body>
</html>
